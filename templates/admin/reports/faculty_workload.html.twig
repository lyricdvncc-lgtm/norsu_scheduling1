{% extends 'admin/base.html.twig' %}

{% block stylesheets %}
{{ parent() }}
<style>
    @media print {
        nav, .no-print, .print-hide { display: none !important; }
        @page { size: A4; margin: 1.5cm 1cm; }
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 10pt; }
        .print-header { display: block !important; text-align: center; border-bottom: 3px solid #1e40af; padding-bottom: 1rem; margin-bottom: 1.5rem; }
        .print-header h1 { font-size: 24pt; font-weight: bold; color: #1e40af; }
        .screen-only { display: none !important; }
        .print-only { display: block !important; }
        table { width: 100%; border-collapse: collapse; font-size: 9pt; page-break-inside: auto; }
        thead { display: table-header-group; }
        thead th { background: #1e40af !important; color: white !important; font-weight: 600; padding: 0.5rem 0.25rem; text-align: left; border: 1px solid #1e3a8a; }
        tbody tr { page-break-inside: avoid; border-bottom: 1px solid #e5e7eb; }
        tbody td { padding: 0.4rem 0.25rem; border: 1px solid #e5e7eb; }
        .status-badge { display: inline-block; padding: 0.15rem 0.4rem; border-radius: 0.25rem; font-size: 8pt; font-weight: 600; }
        .status-overloaded { background: #fee2e2 !important; color: #991b1b !important; }
        .status-optimal { background: #d1fae5 !important; color: #065f46 !important; }
        .status-underloaded { background: #fef3c7 !important; color: #92400e !important; }
    }
    .print-only, .print-header { display: none !important; }
    .sort-icon { opacity: 0.3; transition: opacity 0.2s; }
    th:hover .sort-icon { opacity: 0.7; }
    th .sort-icon.active { opacity: 1; }
</style>
{% endblock %}

{% block main_content %}
<div class="p-6 lg:p-8" x-data="workloadApp()">
    {# Page Header #}
    <div class="mb-8 screen-only">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Faculty Workload Report</h1>
                <p class="mt-2 text-sm text-gray-600">
                    System-wide analysis of faculty teaching loads across all departments
                    <span x-show="activeBadge" class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span x-text="activeBadge"></span>
                    </span>
                    <span x-show="loading" class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        <svg class="animate-spin h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                        Loading...
                    </span>
                </p>
            </div>
            <div class="flex space-x-3 no-print">
                <button onclick="window.print()" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                    Print Report
                </button>
            </div>
        </div>
    </div>

    {# Filters #}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6 print-hide">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="h-5 w-5 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                </svg>
                Filters
            </h2>
            <button @click="clearFilters()" class="text-sm text-gray-500 hover:text-gray-700">
                <svg class="inline h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                Clear Filters
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" x-model="filters.search" @input.debounce.300ms="resetPage()" placeholder="Search name, email..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                <select x-model="filters.department" @change="fetchData()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                <select x-model="filters.academicYear" @change="fetchData()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Academic Years</option>
                    {% for year in academic_years %}
                        <option value="{{ year.id }}">{{ year.year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                <select x-model="filters.semester" @change="fetchData()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Semesters</option>
                    <option value="1st">1st Semester</option>
                    <option value="2nd">2nd Semester</option>
                    <option value="summer">Summer</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select x-model="filters.status" @change="resetPage()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <option value="overloaded">Overloaded (&gt;21 units)</option>
                    <option value="optimal">Optimal (15-21 units)</option>
                    <option value="underloaded">Underloaded (&lt;15 units)</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Show entries</label>
                <select x-model.number="perPage" @change="resetPage()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>

    {# Statistics Cards #}
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6 screen-only">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Faculty</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2" x-text="stats.total"></p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Overloaded</p>
                    <p class="text-3xl font-bold text-red-600 mt-2" x-text="stats.overloaded"></p>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Optimal</p>
                    <p class="text-3xl font-bold text-green-600 mt-2" x-text="stats.optimal"></p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Underloaded</p>
                    <p class="text-3xl font-bold text-yellow-600 mt-2" x-text="stats.underloaded"></p>
                </div>
                <div class="bg-yellow-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Average Load</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2" x-text="stats.averageLoad"></p>
                    <p class="text-xs text-gray-500 mt-1">units</p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    {# DataTable #}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden relative">
        {# Loading overlay #}
        <div x-show="loading" class="absolute inset-0 bg-white/70 z-10 flex items-center justify-center">
            <div class="flex items-center space-x-2 text-blue-600">
                <svg class="animate-spin h-6 w-6" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                <span class="text-sm font-medium">Loading data...</span>
            </div>
        </div>
        <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 flex items-center justify-between">
            <h2 class="text-lg font-semibold text-gray-900">Faculty Workload Details</h2>
            <span class="text-sm text-gray-500">Showing <span x-text="paginatedData.length"></span> of <span x-text="filteredData.length"></span> entries</span>
        </div>

        <template x-if="filteredData.length > 0">
            <div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th @click="sortBy('name')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none">
                                    Faculty Member
                                    <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'name' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20">
                                        <path x-show="sort.field !== 'name' || sort.dir === 'asc'" d="M5 12l5-5 5 5H5z"/>
                                        <path x-show="sort.field === 'name' && sort.dir === 'desc'" d="M15 8l-5 5-5-5h10z"/>
                                    </svg>
                                </th>
                                <th @click="sortBy('department')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none">
                                    Department
                                    <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'department' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20">
                                        <path x-show="sort.field !== 'department' || sort.dir === 'asc'" d="M5 12l5-5 5 5H5z"/>
                                        <path x-show="sort.field === 'department' && sort.dir === 'desc'" d="M15 8l-5 5-5-5h10z"/>
                                    </svg>
                                </th>
                                <th @click="sortBy('course_count')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none">
                                    Courses
                                    <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'course_count' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20">
                                        <path x-show="sort.field !== 'course_count' || sort.dir === 'asc'" d="M5 12l5-5 5 5H5z"/>
                                        <path x-show="sort.field === 'course_count' && sort.dir === 'desc'" d="M15 8l-5 5-5-5h10z"/>
                                    </svg>
                                </th>
                                <th @click="sortBy('units')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none">
                                    Total Units
                                    <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'units' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20">
                                        <path x-show="sort.field !== 'units' || sort.dir === 'asc'" d="M5 12l5-5 5 5H5z"/>
                                        <path x-show="sort.field === 'units' && sort.dir === 'desc'" d="M15 8l-5 5-5-5h10z"/>
                                    </svg>
                                </th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Load Progress</th>
                                <th @click="sortBy('status')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100 select-none">
                                    Status
                                    <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'status' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20">
                                        <path x-show="sort.field !== 'status' || sort.dir === 'asc'" d="M5 12l5-5 5 5H5z"/>
                                        <path x-show="sort.field === 'status' && sort.dir === 'desc'" d="M15 8l-5 5-5-5h10z"/>
                                    </svg>
                                </th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Details</th>
                            </tr>
                        </thead>
                        <template x-for="fac in paginatedData" :key="fac.id">
                            <tbody class="divide-y divide-gray-200">
                                <tr class="bg-white hover:bg-gray-50 cursor-pointer" @click="toggleExpand(fac.id)">
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="flex items-center">
                                            <div class="h-10 w-10 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-medium text-sm screen-only">
                                                <span x-text="fac.initials"></span>
                                            </div>
                                            <div class="ml-4">
                                                <div class="text-sm font-medium text-gray-900" x-text="fac.name"></div>
                                                <div class="text-sm text-gray-500" x-text="fac.email"></div>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="text-sm text-gray-600" x-text="fac.department"></span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm text-gray-900">
                                            <span x-text="fac.course_count"></span> course<span x-show="fac.course_count !== 1">s</span>
                                        </div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-bold text-gray-900"><span x-text="fac.units"></span> / <span x-text="standardLoad"></span></div>
                                        <div class="text-xs text-gray-500">units</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="w-full bg-gray-200 rounded-full h-2.5 screen-only">
                                            <div class="h-2.5 rounded-full transition-all duration-300"
                                                 :class="fac.status === 'overloaded' ? 'bg-red-600' : (fac.status === 'underloaded' ? 'bg-yellow-500' : 'bg-green-600')"
                                                 :style="'width: ' + Math.min(fac.percentage, 100) + '%'"></div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1" x-text="fac.percentage.toFixed(1) + '%'"></div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span class="status-badge px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full"
                                              :class="{
                                                  'status-overloaded bg-red-100 text-red-800': fac.status === 'overloaded',
                                                  'status-underloaded bg-yellow-100 text-yellow-800': fac.status === 'underloaded',
                                                  'status-optimal bg-green-100 text-green-800': fac.status === 'optimal'
                                              }">
                                            <span x-text="fac.status.charAt(0).toUpperCase() + fac.status.slice(1)"></span>
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-center">
                                        <button @click.stop="toggleExpand(fac.id)" class="text-blue-600 hover:text-blue-900 text-sm font-medium screen-only">
                                            <span x-show="expandedId !== fac.id">View</span>
                                            <span x-show="expandedId === fac.id">Hide</span>
                                        </button>
                                    </td>
                                </tr>
                                <tr x-show="expandedId === fac.id" class="bg-blue-50">
                                    <td colspan="7" class="px-6 py-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <h4 class="text-sm font-semibold text-gray-900">
                                                Course Assignments for <span x-text="fac.name" class="text-blue-700"></span>
                                                (<span x-text="fac.course_count"></span> course<span x-show="fac.course_count !== 1">s</span>)
                                            </h4>
                                            <button @click="expandedId = null" class="text-gray-400 hover:text-gray-600 screen-only">
                                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                                            </button>
                                        </div>
                                        <template x-if="fac.courses.length > 0">
                                            <div class="overflow-x-auto">
                                                <table class="min-w-full divide-y divide-gray-200 bg-white rounded-lg overflow-hidden shadow-sm">
                                                    <thead class="bg-gray-100">
                                                        <tr>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Course Code</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Course Name</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Section</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Units</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Schedule</th>
                                                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Room</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody class="bg-white divide-y divide-gray-200">
                                                        <template x-for="(course, idx) in fac.courses" :key="idx">
                                                            <tr class="hover:bg-gray-50">
                                                                <td class="px-4 py-2 text-sm font-medium text-gray-900" x-text="course.code"></td>
                                                                <td class="px-4 py-2 text-sm text-gray-900" x-text="course.name"></td>
                                                                <td class="px-4 py-2 text-sm text-gray-900" x-text="course.section || 'N/A'"></td>
                                                                <td class="px-4 py-2 text-sm text-gray-900" x-text="course.units"></td>
                                                                <td class="px-4 py-2 text-sm text-gray-500" x-text="course.schedule || 'Not scheduled'"></td>
                                                                <td class="px-4 py-2 text-sm text-gray-500" x-text="course.room || 'TBA'"></td>
                                                            </tr>
                                                        </template>
                                                    </tbody>
                                                </table>
                                            </div>
                                        </template>
                                        <template x-if="fac.courses.length === 0">
                                            <p class="text-sm text-gray-500 italic">No courses assigned</p>
                                        </template>
                                    </td>
                                </tr>
                            </tbody>
                        </template>
                    </table>
                </div>

                {# Pagination #}
                <div class="px-6 py-4 border-t border-gray-200 flex items-center justify-between" x-show="totalPages > 1">
                    <p class="text-sm text-gray-700">
                        Showing <span x-text="(page - 1) * perPage + 1"></span> to <span x-text="Math.min(page * perPage, filteredData.length)"></span> of <span x-text="filteredData.length"></span> entries
                    </p>
                    <div class="flex gap-1">
                        <button @click="page = Math.max(1, page - 1)" :disabled="page === 1" class="px-3 py-1 text-sm border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Previous</button>
                        <template x-for="p in visiblePages" :key="p">
                            <button @click="page = p" :class="p === page ? 'bg-blue-600 text-white border-blue-600' : 'hover:bg-gray-50'" class="px-3 py-1 text-sm border rounded" x-text="p"></button>
                        </template>
                        <button @click="page = Math.min(totalPages, page + 1)" :disabled="page === totalPages" class="px-3 py-1 text-sm border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">Next</button>
                    </div>
                </div>
            </div>
        </template>

        <template x-if="filteredData.length === 0 && !loading">
            <div class="px-6 py-12 text-center">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No workload data</h3>
                <p class="mt-1 text-sm text-gray-500">No faculty members found matching your filters.</p>
            </div>
        </template>
    </div>
</div>

<script>
function workloadApp() {
    return {
        filters: {
            academicYear: '{{ selected_academic_year }}',
            semester: '{{ selected_semester }}',
            department: '{{ selected_department }}',
            status: '',
            search: ''
        },
        sort: { field: 'units', dir: 'desc' },
        page: 1,
        perPage: 15,
        expandedId: null,
        loading: false,
        standardLoad: {{ statistics.standard_load }},
        jsonUrl: '{{ path('admin_reports_faculty_workload_json') }}',

        academicYears: {
            {% for year in academic_years %}
            '{{ year.id }}': {{ year.year|json_encode|raw }}{{ not loop.last ? ',' : '' }}
            {% endfor %}
        },

        allData: [
            {% for faculty in workload_data %}
            {
                id: {{ faculty.id }},
                name: {{ faculty.name|json_encode|raw }},
                email: {{ faculty.email|json_encode|raw }},
                department: {{ faculty.department|json_encode|raw }},
                initials: {{ (faculty.name|split(' ')|map(n => n|slice(0,1))|join)|json_encode|raw }},
                units: {{ faculty.units }},
                percentage: {{ faculty.percentage|round(1) }},
                status: {{ faculty.status|json_encode|raw }},
                status_color: {{ faculty.status_color|json_encode|raw }},
                course_count: {{ faculty.course_count }},
                courses: [
                    {% for course in faculty.courses %}
                    {
                        code: {{ course.code|json_encode|raw }},
                        name: {{ course.name|json_encode|raw }},
                        section: {{ (course.section ?? '')|json_encode|raw }},
                        units: {{ course.units }},
                        schedule: {{ (course.schedule ?? '')|json_encode|raw }},
                        room: {{ (course.room ?? '')|json_encode|raw }}
                    }{{ not loop.last ? ',' : '' }}
                    {% endfor %}
                ]
            }{{ not loop.last ? ',' : '' }}
            {% endfor %}
        ],

        get filteredData() {
            let data = this.allData;
            if (this.filters.status) {
                data = data.filter(f => f.status === this.filters.status);
            }
            if (this.filters.search) {
                const q = this.filters.search.toLowerCase();
                data = data.filter(f =>
                    f.name.toLowerCase().includes(q) ||
                    f.email.toLowerCase().includes(q) ||
                    f.department.toLowerCase().includes(q) ||
                    f.courses.some(c => c.code.toLowerCase().includes(q) || c.name.toLowerCase().includes(q))
                );
            }
            if (this.sort.field) {
                data = [...data].sort((a, b) => {
                    let va = a[this.sort.field], vb = b[this.sort.field];
                    if (typeof va === 'string') va = va.toLowerCase();
                    if (typeof vb === 'string') vb = vb.toLowerCase();
                    if (va < vb) return this.sort.dir === 'asc' ? -1 : 1;
                    if (va > vb) return this.sort.dir === 'asc' ? 1 : -1;
                    return 0;
                });
            }
            return data;
        },

        get paginatedData() {
            const start = (this.page - 1) * this.perPage;
            return this.filteredData.slice(start, start + this.perPage);
        },

        get totalPages() {
            return Math.ceil(this.filteredData.length / this.perPage) || 1;
        },

        get visiblePages() {
            const pages = [];
            const start = Math.max(1, this.page - 2);
            const end = Math.min(this.totalPages, this.page + 2);
            for (let i = start; i <= end; i++) pages.push(i);
            return pages;
        },

        get stats() {
            const data = this.filteredData;
            const total = data.length;
            const overloaded = data.filter(f => f.status === 'overloaded').length;
            const optimal = data.filter(f => f.status === 'optimal').length;
            const underloaded = data.filter(f => f.status === 'underloaded').length;
            const totalUnits = data.reduce((sum, f) => sum + f.units, 0);
            const averageLoad = total > 0 ? (totalUnits / total).toFixed(2) : '0.00';
            return { total, overloaded, optimal, underloaded, averageLoad };
        },

        sortBy(field) {
            if (this.sort.field === field) {
                this.sort.dir = this.sort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                this.sort = { field, dir: 'asc' };
            }
            this.page = 1;
        },

        toggleExpand(id) { this.expandedId = this.expandedId === id ? null : id; },
        resetPage() { this.page = 1; this.expandedId = null; },

        clearFilters() {
            const needsRefetch = this.filters.academicYear !== '' || this.filters.semester !== '' || this.filters.department !== '';
            this.filters = { academicYear: '', semester: '', department: '', status: '', search: '' };
            this.page = 1;
            this.expandedId = null;
            if (needsRefetch) this.fetchData();
        },

        get activeBadge() {
            if (this.filters.academicYear && this.filters.semester) {
                const yearLabel = this.academicYears[this.filters.academicYear] || this.filters.academicYear;
                return yearLabel + ' | ' + this.filters.semester + ' Semester';
            }
            return '';
        },

        async fetchData() {
            this.loading = true;
            this.page = 1;
            this.expandedId = null;
            try {
                const params = new URLSearchParams();
                if (this.filters.academicYear) params.set('academic_year', this.filters.academicYear);
                if (this.filters.semester) params.set('semester', this.filters.semester);
                if (this.filters.department) params.set('department', this.filters.department);
                const resp = await fetch(this.jsonUrl + '?' + params.toString());
                if (!resp.ok) throw new Error('Network error');
                const json = await resp.json();
                this.allData = json.faculty;
                this.standardLoad = json.statistics.standard_load;
            } catch (e) {
                console.error('Failed to fetch workload data:', e);
            } finally {
                this.loading = false;
            }
        }
    };
}
</script>
{% endblock %}
