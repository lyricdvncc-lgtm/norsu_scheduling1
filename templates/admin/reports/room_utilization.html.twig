{% extends 'admin/base.html.twig' %}

{% block stylesheets %}
{{ parent() }}
<style>
    @media print {
        nav, .no-print, .print-hide { display: none !important; }
        @page { size: A4 landscape; margin: 1.5cm 1cm; }
        body { -webkit-print-color-adjust: exact; print-color-adjust: exact; font-size: 10pt; }
        .screen-only { display: none !important; }
    }
    .sort-icon { opacity: 0.3; transition: opacity 0.2s; }
    th:hover .sort-icon { opacity: 0.7; }
    th .sort-icon.active { opacity: 1; }
    .utilization-bar { transition: width 0.6s ease-in-out; }
</style>
{% endblock %}

{% block main_content %}
<div class="p-6 lg:p-8" x-data="roomUtilApp()">
    {# Page Header #}
    <div class="mb-8 screen-only">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Room Utilization Report</h1>
                <p class="mt-2 text-sm text-gray-600">
                    System-wide analysis of room usage and scheduling density across all departments
                    <span x-show="activeBadge" class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"/>
                        </svg>
                        <span x-text="activeBadge"></span>
                    </span>
                    <span x-show="loading" class="ml-2 inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-600">
                        <svg class="animate-spin h-3 w-3 mr-1" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
                        Loading...
                    </span>
                </p>
            </div>
            <div class="flex space-x-3 no-print">
                <button onclick="window.print()" class="inline-flex items-center px-4 py-2 bg-white border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition-colors duration-200">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
                    </svg>
                    Print Report
                </button>
            </div>
        </div>
    </div>

    {# Filters #}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6 print-hide">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-lg font-semibold text-gray-900 flex items-center">
                <svg class="h-5 w-5 text-gray-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                </svg>
                Filters
            </h2>
            <button @click="clearFilters()" class="text-sm text-gray-500 hover:text-gray-700">
                <svg class="inline h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                Clear Filters
            </button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-7 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
                <input type="text" x-model="filters.search" @input.debounce.300ms="resetPage()" placeholder="Search room, building..." class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Department</label>
                <select x-model="filters.department" @change="fetchData()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Departments</option>
                    {% for dept in departments %}
                        <option value="{{ dept.id }}">{{ dept.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Academic Year</label>
                <select x-model="filters.academicYear" @change="fetchData()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Academic Years</option>
                    {% for year in academic_years %}
                        <option value="{{ year.id }}">{{ year.year }}</option>
                    {% endfor %}
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Semester</label>
                <select x-model="filters.semester" @change="fetchData()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Semesters</option>
                    <option value="1st">1st Semester</option>
                    <option value="2nd">2nd Semester</option>
                    <option value="summer">Summer</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Status</label>
                <select x-model="filters.status" @change="resetPage()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Status</option>
                    <option value="high">High Usage (≥75%)</option>
                    <option value="moderate">Moderate (40-74%)</option>
                    <option value="low">Low Usage (<40%)</option>
                    <option value="unused">Unused</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Room Type</label>
                <select x-model="filters.type" @change="resetPage()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="">All Types</option>
                    <option value="classroom">Classroom</option>
                    <option value="laboratory">Laboratory</option>
                    <option value="auditorium">Auditorium</option>
                    <option value="office">Office</option>
                </select>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Show entries</label>
                <select x-model.number="perPage" @change="resetPage()" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="10">10</option>
                    <option value="15">15</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </div>
        </div>
    </div>

    {# Statistics Cards #}
    <div class="grid grid-cols-1 md:grid-cols-5 gap-6 mb-6 screen-only">
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Total Rooms</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2" x-text="stats.total_rooms"></p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">High Usage</p>
                    <p class="text-3xl font-bold text-red-600 mt-2" x-text="stats.high_usage"></p>
                </div>
                <div class="bg-red-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Moderate</p>
                    <p class="text-3xl font-bold text-green-600 mt-2" x-text="stats.moderate_usage"></p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Low / Unused</p>
                    <p class="text-3xl font-bold text-yellow-600 mt-2" x-text="stats.low_usage + stats.unused"></p>
                </div>
                <div class="bg-yellow-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
            </div>
        </div>
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-sm font-medium text-gray-600">Avg Utilization</p>
                    <p class="text-3xl font-bold text-gray-900 mt-2"><span x-text="stats.overall_utilization"></span>%</p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"/>
                    </svg>
                </div>
            </div>
        </div>
    </div>

    {# Room Table #}
    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <div class="flex items-center justify-between">
                <div>
                    <h2 class="text-lg font-semibold text-gray-900">Room Details</h2>
                    <p class="text-sm text-gray-500 mt-0.5">Showing <span x-text="filteredData.length"></span> of <span x-text="allData.length"></span> rooms</p>
                </div>
            </div>
        </div>

        {# Loading State #}
        <div x-show="loading" class="flex items-center justify-center py-12">
            <svg class="animate-spin h-8 w-8 text-blue-500" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>
            <span class="ml-3 text-gray-500">Loading room data...</span>
        </div>

        {# Empty State #}
        <template x-if="!loading && filteredData.length === 0">
            <div class="text-center py-12">
                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
                </svg>
                <h3 class="mt-2 text-sm font-medium text-gray-900">No rooms found</h3>
                <p class="mt-1 text-sm text-gray-500">Try adjusting your filters or select a different semester.</p>
            </div>
        </template>

        {# Table #}
        <div x-show="!loading && filteredData.length > 0" class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th @click="sortBy('code')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Room
                            <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'code' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20"><path :d="sort.field === 'code' && sort.dir === 'desc' ? 'M15 12l-5 5-5-5H15z' : 'M5 8l5-5 5 5H5z'"/></svg>
                        </th>
                        <th @click="sortBy('building')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Building
                            <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'building' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20"><path :d="sort.field === 'building' && sort.dir === 'desc' ? 'M15 12l-5 5-5-5H15z' : 'M5 8l5-5 5 5H5z'"/></svg>
                        </th>
                        <th @click="sortBy('type')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Type
                            <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'type' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20"><path :d="sort.field === 'type' && sort.dir === 'desc' ? 'M15 12l-5 5-5-5H15z' : 'M5 8l5-5 5 5H5z'"/></svg>
                        </th>
                        <th @click="sortBy('capacity')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Capacity
                            <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'capacity' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20"><path :d="sort.field === 'capacity' && sort.dir === 'desc' ? 'M15 12l-5 5-5-5H15z' : 'M5 8l5-5 5 5H5z'"/></svg>
                        </th>
                        <th @click="sortBy('schedule_count')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Schedules
                            <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'schedule_count' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20"><path :d="sort.field === 'schedule_count' && sort.dir === 'desc' ? 'M15 12l-5 5-5-5H15z' : 'M5 8l5-5 5 5H5z'"/></svg>
                        </th>
                        <th @click="sortBy('utilization')" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer hover:bg-gray-100">
                            Utilization
                            <svg class="inline h-4 w-4 sort-icon" :class="sort.field === 'utilization' ? 'active' : ''" fill="currentColor" viewBox="0 0 20 20"><path :d="sort.field === 'utilization' && sort.dir === 'desc' ? 'M15 12l-5 5-5-5H15z' : 'M5 8l5-5 5 5H5z'"/></svg>
                        </th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Hours/Week</th>
                    </tr>
                </thead>
                    <template x-for="room in paginatedData" :key="room.id">
                        <tbody class="bg-white divide-y divide-gray-200">
                        <tr class="hover:bg-gray-50 cursor-pointer" @click="toggleExpand(room.id)">
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="flex-shrink-0 h-10 w-10 rounded-lg flex items-center justify-center text-white text-xs font-bold"
                                         :class="{
                                            'bg-red-500': room.status === 'high',
                                            'bg-green-500': room.status === 'moderate',
                                            'bg-yellow-500': room.status === 'low',
                                            'bg-gray-400': room.status === 'unused'
                                         }">
                                        <span x-text="room.code.substring(0, 3).toUpperCase()"></span>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900" x-text="room.code"></div>
                                        <div class="text-xs text-gray-500" x-text="room.name !== room.code ? room.name : ''"></div>
                                    </div>
                                    <svg class="ml-2 h-4 w-4 text-gray-400 transition-transform" :class="expandedId === room.id ? 'rotate-180' : ''" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="room.building"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium capitalize"
                                      :class="{
                                        'bg-blue-100 text-blue-800': room.type === 'classroom',
                                        'bg-purple-100 text-purple-800': room.type === 'laboratory',
                                        'bg-orange-100 text-orange-800': room.type === 'auditorium',
                                        'bg-gray-100 text-gray-800': room.type === 'office'
                                      }" x-text="room.type">
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="room.capacity ?? '—'"></td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      :class="room.schedule_count > 0 ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-500'"
                                      x-text="room.schedule_count">
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="flex items-center">
                                    <div class="w-24 bg-gray-200 rounded-full h-2.5 mr-3">
                                        <div class="h-2.5 rounded-full utilization-bar"
                                             :class="{
                                                'bg-red-500': room.status === 'high',
                                                'bg-green-500': room.status === 'moderate',
                                                'bg-yellow-500': room.status === 'low',
                                                'bg-gray-300': room.status === 'unused'
                                             }"
                                             :style="'width: ' + room.utilization + '%'">
                                        </div>
                                    </div>
                                    <span class="text-sm font-medium text-gray-700" x-text="room.utilization + '%'"></span>
                                </div>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                      :class="{
                                        'bg-red-100 text-red-800': room.status === 'high',
                                        'bg-green-100 text-green-800': room.status === 'moderate',
                                        'bg-yellow-100 text-yellow-800': room.status === 'low',
                                        'bg-gray-100 text-gray-600': room.status === 'unused'
                                      }" x-text="room.status_label">
                                </span>
                            </td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600" x-text="room.hours_used + ' hrs'"></td>
                        </tr>
                        {# Expanded detail row #}
                        <tr x-show="expandedId === room.id" x-transition class="bg-gray-50 border-t border-gray-100">
                            <td colspan="8" class="px-6 py-4">
                                <template x-if="room.schedules.length > 0">
                                    <div>
                                        <h4 class="text-sm font-semibold text-gray-700 mb-3">Assigned Schedules</h4>
                                        <div class="overflow-x-auto">
                                            <table class="min-w-full divide-y divide-gray-200 text-sm">
                                                <thead class="bg-gray-100">
                                                    <tr>
                                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Subject</th>
                                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Section</th>
                                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Faculty</th>
                                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Days</th>
                                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Time</th>
                                                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Enrolled</th>
                                                    </tr>
                                                </thead>
                                                <tbody class="divide-y divide-gray-100">
                                                    <template x-for="sched in room.schedules" :key="sched.subject_code + sched.section + sched.day_pattern">
                                                        <tr class="hover:bg-gray-50">
                                                            <td class="px-4 py-2">
                                                                <span class="font-medium text-gray-900" x-text="sched.subject_code"></span>
                                                                <span class="text-gray-500 ml-1" x-text="'— ' + sched.subject_title"></span>
                                                            </td>
                                                            <td class="px-4 py-2 text-gray-600" x-text="sched.section"></td>
                                                            <td class="px-4 py-2 text-gray-600" x-text="sched.faculty"></td>
                                                            <td class="px-4 py-2 text-gray-600" x-text="sched.day_pattern"></td>
                                                            <td class="px-4 py-2 text-gray-600" x-text="sched.time"></td>
                                                            <td class="px-4 py-2 text-gray-600" x-text="sched.enrolled ?? '—'"></td>
                                                        </tr>
                                                    </template>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </template>
                                <template x-if="room.schedules.length === 0">
                                    <p class="text-sm text-gray-500 italic">No schedules assigned to this room.</p>
                                </template>
                            </td>
                        </tr>
                        </tbody>
                    </template>
            </table>
        </div>

        {# Pagination #}
        <div x-show="!loading && totalPages > 1" class="px-6 py-4 border-t border-gray-200 flex items-center justify-between">
            <div class="text-sm text-gray-500">
                Showing <span x-text="((page - 1) * perPage) + 1"></span> to <span x-text="Math.min(page * perPage, filteredData.length)"></span> of <span x-text="filteredData.length"></span> rooms
            </div>
            <div class="flex items-center space-x-2">
                <button @click="page = Math.max(1, page - 1)" :disabled="page === 1" class="px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Previous
                </button>
                <template x-for="p in pageNumbers" :key="p">
                    <button @click="page = p" :class="p === page ? 'bg-blue-600 text-white border-blue-600' : 'border-gray-300 hover:bg-gray-50'" class="px-3 py-1.5 text-sm rounded-md border" x-text="p"></button>
                </template>
                <button @click="page = Math.min(totalPages, page + 1)" :disabled="page === totalPages" class="px-3 py-1.5 text-sm rounded-md border border-gray-300 hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next
                </button>
            </div>
        </div>
    </div>

    {# Building Summary #}
    <div x-show="!loading && Object.keys(buildingStats).length > 0" class="mt-6 bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-semibold text-gray-900">Building Summary</h2>
        </div>
        <div class="p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <template x-for="(data, building) in buildingStats" :key="building">
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <h3 class="text-sm font-semibold text-gray-900" x-text="building"></h3>
                            <span class="text-xs text-gray-500"><span x-text="data.used"></span>/<span x-text="data.total"></span> rooms used</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 mb-2">
                            <div class="bg-blue-500 h-2.5 rounded-full utilization-bar"
                                 :style="'width: ' + (data.total > 0 ? Math.round((data.used / data.total) * 100) : 0) + '%'">
                            </div>
                        </div>
                        <p class="text-xs text-gray-500"><span x-text="Math.round(data.hours)"></span> total hours/week</p>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script>
function roomUtilApp() {
    return {
        allData: [],
        loading: true,
        expandedId: null,
        page: 1,
        perPage: 15,
        sort: { field: 'utilization', dir: 'desc' },
        filters: {
            academicYear: '{{ active_year ? active_year.id : '' }}',
            semester: '{{ active_semester ?? '' }}',
            department: '',
            status: '',
            type: '',
            search: ''
        },
        stats: {
            total_rooms: 0, used_rooms: 0, unused_rooms: 0,
            overall_utilization: 0, avg_schedules_per_room: 0,
            high_usage: 0, moderate_usage: 0, low_usage: 0, unused: 0
        },
        buildingStats: {},
        academicYears: {
            {% for year in academic_years %}
            '{{ year.id }}': '{{ year.year }}',
            {% endfor %}
        },
        jsonUrl: '{{ path("admin_reports_room_utilization_json") }}',

        init() { this.fetchData(); },

        get filteredData() {
            let data = [...this.allData];
            if (this.filters.search) {
                const q = this.filters.search.toLowerCase();
                data = data.filter(r =>
                    r.code.toLowerCase().includes(q) ||
                    r.name.toLowerCase().includes(q) ||
                    r.building.toLowerCase().includes(q)
                );
            }
            if (this.filters.status) data = data.filter(r => r.status === this.filters.status);
            if (this.filters.type) data = data.filter(r => r.type === this.filters.type);

            const f = this.sort.field;
            const dir = this.sort.dir === 'asc' ? 1 : -1;
            data.sort((a, b) => {
                let va = a[f], vb = b[f];
                if (typeof va === 'string') va = va.toLowerCase();
                if (typeof vb === 'string') vb = vb.toLowerCase();
                if (va < vb) return -1 * dir;
                if (va > vb) return 1 * dir;
                return 0;
            });
            return data;
        },

        get totalPages() { return Math.ceil(this.filteredData.length / this.perPage) || 1; },

        get paginatedData() {
            const start = (this.page - 1) * this.perPage;
            return this.filteredData.slice(start, start + this.perPage);
        },

        get pageNumbers() {
            const pages = [], total = this.totalPages, current = this.page;
            let start = Math.max(1, current - 2), end = Math.min(total, current + 2);
            if (end - start < 4) {
                if (start === 1) end = Math.min(total, start + 4);
                else start = Math.max(1, end - 4);
            }
            for (let i = start; i <= end; i++) pages.push(i);
            return pages;
        },

        get activeBadge() {
            if (this.filters.academicYear && this.filters.semester) {
                const yearLabel = this.academicYears[this.filters.academicYear] || this.filters.academicYear;
                return yearLabel + ' | ' + this.filters.semester + ' Semester';
            }
            return '';
        },

        sortBy(field) {
            if (this.sort.field === field) this.sort.dir = this.sort.dir === 'asc' ? 'desc' : 'asc';
            else this.sort = { field, dir: 'asc' };
            this.page = 1;
        },

        toggleExpand(id) { this.expandedId = this.expandedId === id ? null : id; },
        resetPage() { this.page = 1; this.expandedId = null; },

        clearFilters() {
            const needsRefetch = this.filters.academicYear !== '' || this.filters.semester !== '' || this.filters.department !== '';
            this.filters = { academicYear: '', semester: '', department: '', status: '', type: '', search: '' };
            this.page = 1; this.expandedId = null;
            if (needsRefetch) this.fetchData();
        },

        async fetchData() {
            this.loading = true; this.page = 1; this.expandedId = null;
            try {
                const params = new URLSearchParams();
                if (this.filters.academicYear) params.set('academic_year', this.filters.academicYear);
                if (this.filters.semester) params.set('semester', this.filters.semester);
                if (this.filters.department) params.set('department', this.filters.department);
                const resp = await fetch(this.jsonUrl + '?' + params.toString());
                if (!resp.ok) throw new Error('Network error');
                const json = await resp.json();
                this.allData = json.rooms;
                this.stats = json.statistics;
                this.buildingStats = json.building_stats;
            } catch (e) {
                console.error('Failed to fetch room utilization data:', e);
            } finally {
                this.loading = false;
            }
        }
    };
}
</script>
{% endblock %}
