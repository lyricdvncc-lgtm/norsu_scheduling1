{% extends isDepartmentHead is defined and isDepartmentHead ? 'department_head/base.html.twig' : 'admin/base.html.twig' %}

{% block title %}Create New Schedule{% endblock %}

{% block main_content %}
<div class="max-w-7xl mx-auto">
    <!-- Breadcrumb -->
    {% if not (isDepartmentHead is defined and isDepartmentHead) %}
        {% if selectedDepartment %}
        <div class="mb-4">
            <nav class="flex" aria-label="Breadcrumb">
                <ol class="inline-flex items-center space-x-1 md:space-x-3">
                    <li class="inline-flex items-center">
                        <a href="{{ path('app_schedule_index') }}" class="inline-flex items-center text-sm font-medium text-gray-700 hover:text-blue-600">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                            </svg>
                            Schedules
                        </a>
                    </li>
                    <li>
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span class="ml-1 text-sm font-medium text-gray-500">{{ selectedDepartment.name }}</span>
                        </div>
                    </li>
                    <li aria-current="page">
                        <div class="flex items-center">
                            <svg class="w-6 h-6 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                            </svg>
                            <span class="ml-1 text-sm font-medium text-blue-600">Create Schedule</span>
                        </div>
                    </li>
                </ol>
            </nav>
        </div>
        {% endif %}
    {% else %}
        <!-- Department Head Breadcrumb -->
        <nav class="mb-6 flex" aria-label="Breadcrumb">
            <ol class="inline-flex items-center space-x-2 text-sm">
                <li class="inline-flex items-center">
                    <a href="{{ path('department_head_dashboard') }}" class="text-gray-600 hover:text-blue-600 transition">
                        <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"/>
                        </svg>
                    </a>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <a href="{{ path('department_head_schedules') }}" class="ml-2 text-gray-600 hover:text-blue-600 transition">Department Schedules</a>
                    </div>
                </li>
                <li>
                    <div class="flex items-center">
                        <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd"/>
                        </svg>
                        <span class="ml-2 text-gray-900 font-medium">Create Schedule</span>
                    </div>
                </li>
            </ol>
        </nav>
    {% endif %}

    <!-- Page Header -->
    <div class="mb-6">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Create New Schedule</h1>
                {% if selectedDepartment %}
                <p class="mt-2 text-sm text-gray-600">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M10.394 2.08a1 1 0 00-.788 0l-7 3a1 1 0 000 1.84L5.25 8.051a.999.999 0 01.356-.257l4-1.714a1 1 0 11.788 1.838L7.667 9.088l1.94.831a1 1 0 00.787 0l7-3a1 1 0 000-1.838l-7-3zM3.31 9.397L5 10.12v4.102a8.969 8.969 0 00-1.05-.174 1 1 0 01-.89-.89 11.115 11.115 0 01.25-3.762zM9.3 16.573A9.026 9.026 0 007 14.935v-3.957l1.818.78a3 3 0 002.364 0l5.508-2.361a11.026 11.026 0 01.25 3.762 1 1 0 01-.89.89 8.968 8.968 0 00-5.35 2.524 1 1 0 01-1.4 0zM6 18a1 1 0 001-1v-2.065a8.935 8.935 0 00-2-.712V17a1 1 0 001 1z"/>
                        </svg>
                        {{ selectedDepartment.college.name }} - {{ selectedDepartment.name }}
                    </span>
                </p>
                {% else %}
                <p class="mt-2 text-sm text-gray-600">Fill in the details below to create a new class schedule</p>
                {% endif %}
            </div>
            <div class="flex gap-2">
                <a href="{{ isDepartmentHead is defined and isDepartmentHead ? path('department_head_schedules') : path('app_schedule_index') }}" class="inline-flex items-center px-4 py-2 border border-gray-300 rounded-lg shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 transition">
                    <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                    </svg>
                    Back to Schedules
                </a>
            </div>
        </div>
    </div>

    <!-- Flash Messages for Conflicts and Errors -->
    {% for message in app.flashes('error') %}
        <div class="mb-6 bg-red-50 border-l-4 border-red-500 rounded-lg p-5 shadow-sm animate-shake">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-semibold text-red-800">Scheduling Conflict Detected</h3>
                    <div class="mt-2 text-sm text-red-700">
                        {{ message|raw }}
                    </div>
                </div>
                <button type="button" class="ml-auto flex-shrink-0 text-red-500 hover:text-red-700" onclick="this.parentElement.parentElement.remove()">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
    {% endfor %}

    {% for message in app.flashes('warning') %}
        <div class="mb-6 bg-yellow-50 border-l-4 border-yellow-400 rounded-lg p-5 shadow-sm">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-semibold text-yellow-800">Warning</h3>
                    <div class="mt-2 text-sm text-yellow-700">
                        {{ message|raw }}
                    </div>
                </div>
                <button type="button" class="ml-auto flex-shrink-0 text-yellow-500 hover:text-yellow-700" onclick="this.parentElement.parentElement.remove()">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
    {% endfor %}

    {% for message in app.flashes('success') %}
        <div class="mb-6 bg-green-50 border-l-4 border-green-500 rounded-lg p-5 shadow-sm">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-6 w-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <div class="ml-3 flex-1">
                    <h3 class="text-sm font-semibold text-green-800">Success</h3>
                    <div class="mt-2 text-sm text-green-700">
                        {{ message|raw }}
                    </div>
                </div>
                <button type="button" class="ml-auto flex-shrink-0 text-green-500 hover:text-green-700" onclick="this.parentElement.parentElement.remove()">
                    <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
        </div>
    {% endfor %}

    <!-- Active Semester Notice -->
    {% if activeAcademicYear and activeSemester %}
    <div class="mb-6 bg-blue-50 border-l-4 border-blue-500 rounded-lg p-5 shadow-sm">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <h3 class="text-sm font-semibold text-blue-800">üìÖ Active Semester Pre-selected</h3>
                <div class="mt-2 text-sm text-blue-700">
                    The form is pre-filled with the active semester: <strong>{{ activeSemester }} {{ activeAcademicYear.year }}</strong>. 
                    You can change these values if needed.
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Semester Filter Notice -->
    {% if semesterFilter is defined and semesterFilter %}
    <div class="mb-6 bg-purple-50 border-l-4 border-purple-500 rounded-lg p-5 shadow-sm">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <svg class="h-6 w-6 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"/>
                </svg>
            </div>
            <div class="ml-3 flex-1">
                <div class="flex items-center justify-between">
                    <h3 class="text-sm font-semibold text-purple-800"> Subject Filter Active</h3>
                    <select id="semester-view-filter" class="text-xs px-3 py-1.5 border border-purple-300 rounded-lg bg-white text-purple-700 font-medium focus:outline-none focus:ring-2 focus:ring-purple-500 transition" onchange="filterSubjectsBySemester()">
                        <option value="active" selected>Active Semester Only</option>
                        <option value="all">All Semesters</option>
                    </select>
                </div>
                <div class="mt-2 text-sm text-purple-700">
                    <span id="filter-status-text">Showing only <strong>{{ semesterFilter }}</strong> semester subjects.</span>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Left Column: Form -->
        <div class="lg:col-span-2">
            <form method="post" action="{{ isDepartmentHead is defined and isDepartmentHead ? path('department_head_schedules_create') : path('app_schedule_new') }}" id="scheduleForm" class="space-y-6" novalidate">
                
                <!-- Step 1: Subject Details -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold text-lg">1</div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Subject & Section Details</h2>
                            <p class="text-sm text-gray-500">Select the subject and specify section information</p>
                        </div>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label for="subject" class="block text-sm font-medium text-gray-700 mb-2">
                                Subject <span class="text-red-500">*</span>
                            </label>
                            <select id="subject" name="subject" required 
                                    class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition"
                                    style="max-height: 300px; overflow-y: auto;"
                                    size="1"
                                    onchange="updateSubjectInfo()">
                                <option value="">Choose a subject...</option>
                                {% for subject in subjects %}
                                    <option value="{{ subject.id }}" 
                                            data-subject-code="{{ subject.code }}"
                                            data-subject-title="{{ subject.title }}"
                                            data-subject-units="{{ subject.units }}"
                                            data-subject-semester="{{ subject.semester }}"
                                            class="subject-option subject-semester-{{ subject.semester }}">
                                        {{ subject.code }} - {{ subject.title }} ({{ subject.units }} units)
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="mt-1 text-xs text-gray-500">Select the subject for this schedule (scroll to see all)</p>
                        </div>

                        <!-- Existing Sections Info -->
                        <div id="existing-sections-info" class="hidden bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-3 shadow-sm mb-4">
                            <div class="flex items-start gap-2">
                                <div class="flex-1">
                                    <p class="text-xs font-bold text-blue-900 mb-1.5">
                                        Existing Sections for this Subject:
                                    </p>
                                    <div id="existing-sections-list" class="flex flex-wrap gap-1.5"></div>
                                    <p class="text-xs text-blue-700 mt-1.5 italic">Choose a unique section name to avoid conflicts</p>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label for="section" class="block text-sm font-medium text-gray-700 mb-2">
                                    Section <span class="text-red-500">*</span>
                                </label>
                                <div class="relative">
                                    <input type="text" id="section" name="section" required
                                           placeholder="e.g., A, B, 1, 2, BSIT-3A"
                                           class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition"
                                           oninput="checkSectionExists()">
                                    <div id="section-status-icon" class="hidden absolute right-3 top-1/2 -translate-y-1/2"></div>
                                </div>
                                <p class="mt-1 text-xs text-gray-500" id="section-hint">Class section identifier</p>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Semester <span class="text-red-500">*</span>
                                    {% if activeSemester %}
                                        <span class="ml-2 text-xs text-purple-600 font-normal">(Active semester)</span>
                                    {% endif %}
                                </label>
                                {% if activeSemester %}
                                    <div class="block w-full rounded-lg border border-purple-200 bg-purple-50 px-4 py-2.5 text-gray-900 font-medium">
                                        {{ activeSemester == '1st' ? '1st Semester' : (activeSemester == '2nd' ? '2nd Semester' : 'Summer') }}
                                    </div>
                                    <input type="hidden" id="semester" name="semester" value="{{ activeSemester }}">
                                {% else %}
                                    <select id="semester" name="semester" required
                                            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition"
                                            onchange="updatePreview(); checkSectionExists(); updateExistingSectionsDisplay();">
                                        <option value="">Select semester...</option>
                                        <option value="1st">1st Semester</option>
                                        <option value="2nd">2nd Semester</option>
                                        <option value="Summer">Summer</option>
                                    </select>
                                {% endif %}
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Academic Year <span class="text-red-500">*</span>
                                    {% if activeAcademicYear %}
                                        <span class="ml-2 text-xs text-purple-600 font-normal">(Active year)</span>
                                    {% endif %}
                                </label>
                                {% if activeAcademicYear %}
                                    <div class="block w-full rounded-lg border border-purple-200 bg-purple-50 px-4 py-2.5 text-gray-900 font-medium">
                                        {{ activeAcademicYear.year }}
                                    </div>
                                    <input type="hidden" id="academic_year" name="academic_year" value="{{ activeAcademicYear.id }}">
                                {% else %}
                                    <select id="academic_year" name="academic_year" required
                                            class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition"
                                            onchange="updatePreview(); checkSectionExists(); updateExistingSectionsDisplay();">
                                        <option value="">Select year...</option>
                                        {% for ay in academicYears %}
                                            <option value="{{ ay.id }}">{{ ay.year }}</option>
                                        {% endfor %}
                                    </select>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Schedule Time & Days -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold text-lg">2</div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Schedule Time & Days</h2>
                            <p class="text-sm text-gray-500">Set the class meeting days and time</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="day_pattern" class="block text-sm font-medium text-gray-700 mb-2">
                                Day Pattern <span class="text-red-500">*</span>
                            </label>
                            <select id="day_pattern" name="day_pattern" required 
                                    class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition"
                                    onchange="updatePreview(); checkRoomConflicts();">
                                <option value="">Select pattern...</option>
                                <option value="MWF">Mon-Wed-Fri</option>
                                <option value="TTH">Tue-Thu</option>
                                <option value="MTWTHF">Mon-Fri (Daily)</option>
                                <option value="MW">Mon-Wed</option>
                                <option value="WF">Wed-Fri</option>
                                <option value="MTH">Mon-Thu</option>
                                <option value="TF">Tue-Fri</option>
                                <option value="SAT">Saturday Only</option>
                                <option value="SUN">Sunday Only</option>
                            </select>
                        </div>

                        <div>
                            <label for="start_time" class="block text-sm font-medium text-gray-700 mb-2">
                                Start Time <span class="text-red-500">*</span>
                            </label>
                            <input type="time" id="start_time" name="start_time" required 
                                   min="07:00" max="21:00"
                                   onchange="calculateEndTime(); updatePreview(); checkRoomConflicts();"
                                   class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition">
                            <p class="mt-1 text-xs text-gray-500">Classes typically 7 AM - 9 PM</p>
                        </div>

                        <div>
                            <label for="end_time" class="block text-sm font-medium text-gray-700 mb-2">
                                End Time <span class="text-red-500">*</span>
                            </label>
                            <input type="time" id="end_time" name="end_time" required 
                                   min="07:00" max="21:00"
                                   onchange="updatePreview(); checkRoomConflicts();"
                                   class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition">
                            <p class="mt-1 text-xs text-gray-500" id="duration-hint">Duration: --</p>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Room & Enrollment -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center gap-3 mb-6">
                        <div class="w-10 h-10 bg-blue-600 text-white rounded-full flex items-center justify-center font-semibold text-lg">3</div>
                        <div>
                            <h2 class="text-xl font-semibold text-gray-900">Room & Enrollment</h2>
                            <p class="text-sm text-gray-500">Assign a room and specify enrollment details</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="room" class="block text-sm font-medium text-gray-700 mb-2">
                                Room <span class="text-red-500">*</span>
                            </label>
                            <select id="room" name="room" required 
                                    class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition"
                                    onchange="checkCapacity(); updatePreview(); checkRoomConflicts();">
                                <option value="">Select room...</option>
                                {% for room in rooms %}
                                    <option value="{{ room.id }}" data-capacity="{{ room.capacity }}">
                                        {{ room.building }} - {{ room.name }} 
                                        {% if room.capacity %}(Capacity: {{ room.capacity }}){% endif %}
                                    </option>
                                {% endfor %}
                            </select>
                            <p class="mt-1 text-xs text-gray-500" id="room-conflict-hint">Select all details to check room availability</p>
                        </div>

                        <div>
                            <label for="enrolled_students" class="block text-sm font-medium text-gray-700 mb-2">
                                Enrolled Students
                            </label>
                            <input type="number" id="enrolled_students" name="enrolled_students" 
                                   placeholder="Number of students" min="0" max="999"
                                   onchange="checkCapacity()"
                                   class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition">
                            <p class="mt-1 text-xs" id="capacity-warning"></p>
                        </div>

                        <div class="md:col-span-2">
                            <label for="notes" class="block text-sm font-medium text-gray-700 mb-2">
                                Notes (Optional)
                            </label>
                            <textarea id="notes" name="notes" rows="3" 
                                      placeholder="Additional notes, requirements, or special instructions..."
                                      class="block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition"></textarea>
                        </div>
                    </div>
                </div>

                <!-- Form Actions -->
                <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <p class="text-sm text-gray-600">
                            <span class="text-red-500">*</span> Required fields
                        </p>
                        <div class="flex gap-3">
                            <a href="{{ path('app_schedule_index') }}" 
                               class="px-6 py-2.5 border border-gray-300 text-gray-700 bg-white rounded-lg hover:bg-gray-50 transition font-medium">
                                Cancel
                            </a>
                            <button type="submit" id="submitBtn"
                                    class="px-8 py-2.5 bg-green-600 text-white rounded-lg hover:bg-green-700 transition font-medium shadow-sm hover:shadow-md">
                                <span id="submitBtnText">Create Schedule</span>
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>

        <!-- Right Column: Preview & Information -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Auto Conflict Detection Info -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg shadow-sm border border-blue-200 p-6">
                <div class="flex items-start gap-3">
                    <svg class="w-6 h-6 text-blue-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                    </svg>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Auto Conflict Detection</h3>
                        <p class="text-sm text-gray-700 leading-relaxed mb-3">
                            The system will automatically check for scheduling conflicts when you create this schedule. 
                            Conflicts include room overlaps and section time conflicts.
                        </p>
                        <div class="space-y-2 text-sm">
                            <div class="flex items-start gap-2">
                                <span class="text-red-600 font-bold">üö´</span>
                                <p class="text-gray-700"><span class="font-semibold">Blocks Creation:</span> Room-time conflicts, duplicate subject-section, section double-booking</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <span class="text-yellow-600 font-bold">‚ö†Ô∏è</span>
                                <p class="text-gray-700"><span class="font-semibold">Shows Warning:</span> Room over-capacity or near capacity</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Live Conflict Detection Results -->
            <div id="live-conflict-detection" class="hidden bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <div class="flex items-start gap-3 mb-3">
                    <div id="conflict-icon"></div>
                    <div class="flex-1">
                        <h3 id="conflict-title" class="text-lg font-semibold mb-2"></h3>
                        <div id="conflict-details" class="space-y-2"></div>
                    </div>
                </div>
                <div id="conflict-loading" class="hidden">
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <svg class="animate-spin h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        <span>Checking for conflicts...</span>
                    </div>
                </div>
            </div>

            <!-- Schedule Preview -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                    </svg>
                    Schedule Preview
                </h3>
                
                <div id="schedule-preview" class="space-y-3">
                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10A7.969 7.969 0 015.5 14c1.669 0 3.218.51 4.5 1.385A7.962 7.962 0 0114.5 14c1.255 0 2.443.29 3.5.804v-10A7.968 7.968 0 0014.5 4c-1.255 0-2.443.29-3.5.804V12a1 1 0 11-2 0V4.804z"/>
                        </svg>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-gray-500">Subject</p>
                            <p id="preview-subject" class="text-sm text-gray-900 font-medium">Not selected</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"/>
                        </svg>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-gray-500">Schedule</p>
                            <p id="preview-schedule" class="text-sm text-gray-900 font-medium">Not set</p>
                        </div>
                    </div>

                    <div class="flex items-start gap-3">
                        <svg class="w-5 h-5 text-gray-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a1 1 0 110 2h-3a1 1 0 01-1-1v-2a1 1 0 00-1-1H9a1 1 0 00-1 1v2a1 1 0 01-1 1H4a1 1 0 110-2V4zm3 1h2v2H7V5zm2 4H7v2h2V9zm2-4h2v2h-2V5zm2 4h-2v2h2V9z" clip-rule="evenodd"/>
                        </svg>
                        <div class="flex-1">
                            <p class="text-xs font-medium text-gray-500">Room</p>
                            <p id="preview-room" class="text-sm text-gray-900 font-medium">Not selected</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Helpful Tips -->
            <div class="bg-amber-50 rounded-lg shadow-sm border border-amber-200 p-5">
                <h4 class="text-sm font-semibold text-amber-900 mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"/>
                    </svg>
                    Tips for Better Scheduling
                </h4>
                <ul class="space-y-2 text-xs text-amber-900">
                    <li class="flex items-start gap-2">
                        <span class="text-amber-600">‚Ä¢</span>
                        <span>Verify room capacity matches enrollment</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-amber-600">‚Ä¢</span>
                        <span>Check that times don't overlap with other classes</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-amber-600">‚Ä¢</span>
                        <span>Standard class duration is 1-3 hours</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-amber-600">‚Ä¢</span>
                        <span>MWF classes are typically 1 hour each</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <span class="text-amber-600">‚Ä¢</span>
                        <span>TTH classes are typically 1.5 hours each</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<script>
// Store existing schedules data
let existingSchedules = {};

// Update subject info preview and show existing sections
function updateSubjectInfo() {
    const select = document.getElementById('subject');
    const selectedOption = select.options[select.selectedIndex];
    
    if (select.value) {
        // Update preview only
        document.getElementById('preview-subject').textContent = 
            selectedOption.getAttribute('data-subject-code') + ' - ' + 
            selectedOption.getAttribute('data-subject-title');
        
        // Fetch and display existing sections for this subject
        fetchExistingSections(select.value);
    } else {
        document.getElementById('preview-subject').textContent = 'Not selected';
        hideExistingSections();
    }
    updatePreview();
}

// Fetch existing sections for the selected subject
function fetchExistingSections(subjectId) {
    console.log('=== FETCHING EXISTING SECTIONS ===');
    console.log('Subject ID:', subjectId);
    
    const isDepartmentHead = {{ isDepartmentHead is defined and isDepartmentHead ? 'true' : 'false' }};
    const url = isDepartmentHead 
        ? `/department-head/schedules/existing-sections/${subjectId}`
        : `/admin/schedule/existing-sections/${subjectId}`;
    
    console.log('Fetching from URL:', url);
    
    fetch(url)
        .then(response => {
            console.log('Response status:', response.status);
            if (!response.ok) {
                if (response.status === 403) {
                    console.error('403 Forbidden - Subject may not belong to your department');
                }
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('=== RECEIVED DATA FROM BACKEND ===');
            console.log('Raw data:', data);
            console.log('Schedules map:', data.schedules);
            console.log('Schedules map keys:', Object.keys(data.schedules || {}));
            console.log('Sections array:', data.sections);
            
            existingSchedules = data.schedules || {};
            displayExistingSections(data.sections || []);
            
            console.log('=== STORED IN existingSchedules ===');
            console.log('Keys stored:', Object.keys(existingSchedules));
            console.log('Full map:', existingSchedules);
        })
        .catch(error => {
            console.error('Error fetching existing sections:', error);
            hideExistingSections();
        });
}

// Display existing sections for the currently selected semester and year
function displayExistingSections(sections) {
    console.log('Displaying sections:', sections);
    updateExistingSectionsDisplay();
}

// Update the display based on current semester/year selection
function updateExistingSectionsDisplay() {
    const semester = document.getElementById('semester').value;
    const academicYear = document.getElementById('academic_year').value;
    const infoBox = document.getElementById('existing-sections-info');
    const listContainer = document.getElementById('existing-sections-list');
    
    // If semester and year are not selected, show all sections
    if (!semester || !academicYear) {
        // Show all unique sections
        const allSections = new Set();
        Object.values(existingSchedules).forEach(schedule => {
            allSections.add(schedule.section);
        });
        
        if (allSections.size > 0) {
            const sectionsArray = Array.from(allSections).sort();
            listContainer.innerHTML = sectionsArray.map(section => 
                `<span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold bg-blue-100 text-blue-700 border border-blue-300">
                    Section ${section}
                </span>`
            ).join('');
            infoBox.classList.remove('hidden');
        } else {
            hideExistingSections();
        }
        return;
    }
    
    // Filter sections for current semester and year
    const currentSections = [];
    Object.entries(existingSchedules).forEach(([key, schedule]) => {
        if (schedule.semester === semester && schedule.yearId == academicYear) {
            currentSections.push(schedule.section);
        }
    });
    
    if (currentSections.length > 0) {
        currentSections.sort();
        const yearText = Object.values(existingSchedules).find(s => s.yearId == academicYear)?.year || '';
        listContainer.innerHTML = currentSections.map(section => 
            `<span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-semibold bg-blue-100 text-blue-700 border border-blue-300">
                Section ${section}
            </span>`
        ).join('');
        infoBox.classList.remove('hidden');
    } else {
        hideExistingSections();
    }
}

// Hide existing sections info
function hideExistingSections() {
    document.getElementById('existing-sections-info').classList.add('hidden');
    existingSchedules = {};
}

// Check if section already exists
function checkSectionExists() {
    const sectionInput = document.getElementById('section');
    const section = sectionInput.value.trim().toUpperCase();
    const subjectSelect = document.getElementById('subject');
    const subjectId = subjectSelect ? subjectSelect.value : '';
    const semester = document.getElementById('semester').value;
    const academicYear = document.getElementById('academic_year').value;
    const hintElement = document.getElementById('section-hint');
    const statusIcon = document.getElementById('section-status-icon');
    
    console.log('=== CHECK SECTION EXISTS ===');
    console.log('Input Section:', sectionInput.value);
    console.log('Normalized Section:', section);
    console.log('Subject ID:', subjectId);
    console.log('Semester value:', semester);
    console.log('Academic Year ID:', academicYear);
    console.log('existingSchedules map:', existingSchedules);
    console.log('All keys in map:', Object.keys(existingSchedules || {}));
    
    if (!section) {
        hintElement.textContent = 'Class section identifier';
        hintElement.className = 'mt-1 text-xs text-gray-500';
        sectionInput.className = 'block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition';
        if (statusIcon) statusIcon.classList.add('hidden');
        return;
    }
    
    // If no semester/year/subject selected, just show neutral message
    if (!semester || !academicYear || !subjectId) {
        hintElement.textContent = 'Select subject, semester & academic year to check availability';
        hintElement.className = 'mt-1 text-xs text-gray-500';
        sectionInput.className = 'block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition';
        if (statusIcon) statusIcon.classList.add('hidden');
        return;
    }
    
    // Check if this exact combination exists (subject + section + semester + year)
    const key = `${subjectId}_${section}_${semester}_${academicYear}`;
    console.log('=== DUPLICATE CHECK ===');
    console.log('Looking for key:', key);
    console.log('Keys available:', Object.keys(existingSchedules || {}));
    
    // Also try to find manually to debug
    const manualCheck = Object.entries(existingSchedules).find(([k, v]) => {
        console.log(`Comparing key "${k}" with "${key}"`);
        console.log(`  - Section match: "${v.section.toUpperCase()}" === "${section}" = ${v.section.toUpperCase() === section}`);
        console.log(`  - Semester match: "${v.semester}" === "${semester}" = ${v.semester === semester}`);
        console.log(`  - Year match: ${v.yearId} == ${academicYear} = ${v.yearId == academicYear}`);
        return k === key;
    });
    
    const exists = existingSchedules[key];
    console.log('Direct lookup result:', exists);
    console.log('Manual check result:', manualCheck);
    
    if (exists) {
        console.log('üö´ DUPLICATE FOUND:', exists);
        
        // Change input background to light purple
        sectionInput.className = 'block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition bg-purple-50';
        
        // Show error icon
        if (statusIcon) {
            statusIcon.innerHTML = `
                <svg class="w-5 h-5 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
            `;
            statusIcon.classList.remove('hidden');
        }
        
        hintElement.innerHTML = `<span class="flex items-center gap-1.5">
            ‚ö†Ô∏è Section ${section} already exists for ${semester} ${exists.year}
        </span>`;
        hintElement.className = 'mt-1 text-sm text-red-600 font-medium';
    } else {
        console.log('‚úÖ Section available for selected semester/year');
        
        // Reset input to normal
        sectionInput.className = 'block w-full rounded-lg border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 transition';
        
        // Hide status icon
        if (statusIcon) {
            statusIcon.classList.add('hidden');
        }
        
        hintElement.textContent = 'Class section identifier';
        hintElement.className = 'mt-1 text-xs text-gray-500';
    }
}

// Check for room conflicts via AJAX
function checkRoomConflicts() {
    const room = document.getElementById('room').value;
    const dayPattern = document.getElementById('day_pattern').value;
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    const semester = document.getElementById('semester').value;
    const academicYear = document.getElementById('academic_year').value;
    const hintElement = document.getElementById('room-conflict-hint');
    
    // Reset hint if missing required fields
    if (!room || !dayPattern || !startTime || !endTime || !semester || !academicYear) {
        hintElement.textContent = 'Select all schedule details to check room availability';
        hintElement.className = 'mt-1 text-xs text-gray-500';
        return;
    }
    
    // Show checking status
    hintElement.innerHTML = '<span class="flex items-center gap-1"><svg class="animate-spin h-3 w-3" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Checking room availability...</span>';
    hintElement.className = 'mt-1 text-xs text-blue-600';
    
    // Determine the correct URL based on user role
    const isDepartmentHead = {{ isDepartmentHead is defined and isDepartmentHead ? 'true' : 'false' }};
    const checkUrl = isDepartmentHead 
        ? '{{ path('department_head_schedules_check_room_conflicts') }}'
        : '/admin/schedule/check-room-conflicts';
    
    // Make AJAX request to check conflicts
    fetch(checkUrl, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: JSON.stringify({
            room: room,
            dayPattern: dayPattern,
            startTime: startTime,
            endTime: endTime,
            semester: semester,
            academicYear: academicYear
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.hasConflict) {
            hintElement.innerHTML = `<span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
                </svg>
                üö´ Room conflict: ${data.conflictMessage}
            </span>`;
            hintElement.className = 'mt-1 text-xs text-red-600 font-medium';
        } else {
            hintElement.innerHTML = `<span class="flex items-center gap-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                </svg>
                ‚úì Room is available
            </span>`;
            hintElement.className = 'mt-1 text-xs text-green-600 font-medium';
        }
    })
    .catch(error => {
        console.error('Error checking room conflicts:', error);
        hintElement.textContent = 'Error checking room availability';
        hintElement.className = 'mt-1 text-xs text-red-600';
    });
}

// Auto-calculate end time (1 hour after start by default)
function calculateEndTime() {
    const startTime = document.getElementById('start_time').value;
    if (startTime) {
        const [hours, minutes] = startTime.split(':');
        let endHour = (parseInt(hours) + 1) % 24;
        const endTime = endHour.toString().padStart(2, '0') + ':' + minutes;
        document.getElementById('end_time').value = endTime;
        updateDuration();
    }
}

// Update duration display
function updateDuration() {
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    const hintEl = document.getElementById('duration-hint');
    
    if (startTime && endTime) {
        const start = new Date('2000-01-01 ' + startTime);
        const end = new Date('2000-01-01 ' + endTime);
        const diff = (end - start) / (1000 * 60); // minutes
        
        if (diff > 0) {
            const hours = Math.floor(diff / 60);
            const minutes = diff % 60;
            let durationText = 'Duration: ';
            if (hours > 0) durationText += hours + (hours === 1 ? ' hour' : ' hours');
            if (minutes > 0) durationText += (hours > 0 ? ' ' : '') + minutes + ' min';
            hintEl.textContent = durationText;
            hintEl.className = 'mt-1 text-xs text-green-600 font-medium';
        } else {
            hintEl.textContent = 'End time must be after start time';
            hintEl.className = 'mt-1 text-xs text-red-600 font-medium';
        }
    } else {
        hintEl.textContent = 'Duration: --';
        hintEl.className = 'mt-1 text-xs text-gray-500';
    }
}

// Check room capacity vs enrolled students
function checkCapacity() {
    const roomSelect = document.getElementById('room');
    const enrolledInput = document.getElementById('enrolled_students');
    const warningEl = document.getElementById('capacity-warning');
    
    if (roomSelect.value && enrolledInput.value) {
        const selectedOption = roomSelect.options[roomSelect.selectedIndex];
        const capacity = parseInt(selectedOption.getAttribute('data-capacity') || 0);
        const enrolled = parseInt(enrolledInput.value);
        
        if (enrolled > capacity) {
            warningEl.textContent = `‚ö†Ô∏è Exceeds room capacity by ${enrolled - capacity}`;
            warningEl.className = 'mt-1 text-xs text-red-600 font-medium';
        } else if (capacity > 0) {
            const remaining = capacity - enrolled;
            warningEl.textContent = `‚úì ${remaining} seats remaining`;
            warningEl.className = 'mt-1 text-xs text-green-600';
        }
    } else {
        warningEl.textContent = '';
    }
}

// Update comprehensive preview
function updatePreview() {
    const dayPattern = document.getElementById('day_pattern').value;
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    const room = document.getElementById('room');
    
    // Update schedule preview
    if (dayPattern && startTime && endTime) {
        const dayLabels = {
            'MWF': 'Mon/Wed/Fri',
            'TTH': 'Tue/Thu',
            'MTWTHF': 'Mon-Fri',
            'MW': 'Mon/Wed',
            'WF': 'Wed/Fri',
            'MTH': 'Mon/Thu',
            'TF': 'Tue/Fri',
            'SAT': 'Saturday',
            'SUN': 'Sunday'
        };
        
        const start = new Date('2000-01-01 ' + startTime);
        const end = new Date('2000-01-01 ' + endTime);
        const startFormatted = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        const endFormatted = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
        
        document.getElementById('preview-schedule').textContent = 
            `${dayLabels[dayPattern] || dayPattern} ‚Ä¢ ${startFormatted} - ${endFormatted}`;
    } else {
        document.getElementById('preview-schedule').textContent = 'Not set';
    }
    
    // Update room preview
    if (room.value) {
        const selectedOption = room.options[room.selectedIndex];
        document.getElementById('preview-room').textContent = selectedOption.text;
    } else {
        document.getElementById('preview-room').textContent = 'Not selected';
    }
    
    updateDuration();
}

// Add event listeners
document.getElementById('start_time').addEventListener('change', updateDuration);
document.getElementById('end_time').addEventListener('change', updateDuration);

// Form submission
document.getElementById('scheduleForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitBtnText');
    
    submitBtn.disabled = true;
    submitText.textContent = 'Creating...';
    
    // Re-enable after 3 seconds in case of error
    setTimeout(() => {
        submitBtn.disabled = false;
        submitText.textContent = 'Create Schedule';
    }, 3000);
});

// Live Conflict Detection
let conflictCheckTimeout;

function checkForConflicts() {
    console.log('=== checkForConflicts called ===');
    
    // Get form values
    const subject = document.getElementById('subject')?.value || '';
    const section = document.getElementById('section')?.value || '';
    const semester = document.getElementById('semester')?.value || '';
    const academicYear = document.getElementById('academic_year')?.value || '';
    const room = document.getElementById('room')?.value || '';
    const dayPattern = document.getElementById('day_pattern')?.value || '';
    const startTime = document.getElementById('start_time')?.value || '';
    const endTime = document.getElementById('end_time')?.value || '';

    console.log('Form data:', { subject, section, semester, academicYear, room, dayPattern, startTime, endTime });

    // Only check if we have all required fields
    if (!subject || !room || !dayPattern || !startTime || !endTime || !semester || !academicYear) {
        console.log('Missing required fields, hiding conflict detection');
        document.getElementById('live-conflict-detection').classList.add('hidden');
        return;
    }

    // Show loading
    const conflictBox = document.getElementById('live-conflict-detection');
    const loadingEl = document.getElementById('conflict-loading');
    conflictBox.classList.remove('hidden');
    loadingEl.classList.remove('hidden');

    // Clear existing timeout
    clearTimeout(conflictCheckTimeout);

    // Debounce the API call
    conflictCheckTimeout = setTimeout(() => {
        const conflictCheckUrl = {% if isDepartmentHead is defined and isDepartmentHead %}'{{ path('department_head_schedules_check_conflicts') }}'{% else %}'{{ path('app_schedule_check_conflict') }}'{% endif %};
        fetch(conflictCheckUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: JSON.stringify({
                subject: subject,
                section: section,
                semester: semester,
                academic_year: academicYear,
                room: room,
                day_pattern: dayPattern,
                start_time: startTime,
                end_time: endTime
            })
        })
        .then(response => {
            console.log('Conflict check response status:', response.status);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            console.log('=== CONFLICT CHECK RESPONSE ===');
            console.log('Full response:', data);
            console.log('Has conflicts:', data.has_conflicts);
            console.log('Conflicts array:', data.conflicts);
            console.log('Warnings array:', data.warnings);
            console.log('Debug info:', data.debug);
            loadingEl.classList.add('hidden');
            displayConflictResults(data);
        })
        .catch(error => {
            console.error('Error checking conflicts:', error);
            loadingEl.classList.add('hidden');
            document.getElementById('live-conflict-detection').classList.add('hidden');
        });
    }, 500);
}

function displayConflictResults(data) {
    const conflictBox = document.getElementById('live-conflict-detection');
    const iconEl = document.getElementById('conflict-icon');
    const titleEl = document.getElementById('conflict-title');
    const detailsEl = document.getElementById('conflict-details');

    if (data.has_conflicts) {
        // Show conflicts
        iconEl.innerHTML = `<svg class="w-6 h-6 text-red-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>`;
        titleEl.textContent = '‚ö†Ô∏è Conflicts Detected';
        titleEl.className = 'text-lg font-semibold text-red-800 mb-2';
        conflictBox.className = 'bg-red-50 border-l-4 border-red-500 rounded-lg shadow-sm p-6';

        let html = '<div class="space-y-3">';
        html += '<p class="text-sm font-semibold text-red-800">The following conflicts were detected:</p>';
        html += '<ul class="space-y-2 text-sm">';
        data.conflicts.forEach(conflict => {
            html += `<li class="flex items-start gap-2 bg-white bg-opacity-50 p-2 rounded">
                <span class="text-red-600 font-bold mt-0.5">üö´</span>
                <span class="text-red-700">${conflict}</span>
            </li>`;
        });
        html += '</ul>';
        html += '<div class="mt-4 p-3 bg-red-100 rounded-lg">';
        html += '<p class="text-sm text-red-900 font-semibold">‚õî Cannot create schedule with these conflicts.</p>';
        html += '<p class="text-xs text-red-800 mt-1">Please change the room, time, or section to resolve conflicts.</p>';
        html += '</div>';
        html += '</div>';
        detailsEl.innerHTML = html;

        // Disable submit button
        document.getElementById('submitBtn').disabled = true;
    } else if (data.warnings && data.warnings.length > 0) {
        // Show warnings only
        iconEl.innerHTML = `<svg class="w-6 h-6 text-yellow-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
        </svg>`;
        titleEl.textContent = '‚ö†Ô∏è Warnings Detected';
        titleEl.className = 'text-lg font-semibold text-yellow-800 mb-2';
        conflictBox.className = 'bg-yellow-50 border-l-4 border-yellow-400 rounded-lg shadow-sm p-6';

        let html = '<div class="space-y-3">';
        html += '<p class="text-sm font-semibold text-yellow-800">Please review the following warnings:</p>';
        html += '<ul class="space-y-2 text-sm">';
        data.warnings.forEach(warning => {
            html += `<li class="flex items-start gap-2 bg-white bg-opacity-50 p-2 rounded">
                <span class="text-yellow-600 font-bold mt-0.5">‚ö†Ô∏è</span>
                <span class="text-yellow-700">${warning}</span>
            </li>`;
        });
        html += '</ul>';
        
        // Add checked items
        html += '<div class="mt-4 space-y-2">';
        html += '<p class="text-xs font-semibold text-yellow-800">‚úì Checked for conflicts:</p>';
        html += '<div class="grid grid-cols-2 gap-2 text-xs text-yellow-700">';
        html += getCheckedItems();
        html += '</div>';
        html += '</div>';
        
        html += '<div class="mt-4 p-3 bg-yellow-100 rounded-lg">';
        html += '<p class="text-sm text-yellow-900 font-semibold">‚úì You can still create this schedule</p>';
        html += '<p class="text-xs text-yellow-800 mt-1">Review the warnings before submitting.</p>';
        html += '</div>';
        html += '</div>';
        detailsEl.innerHTML = html;

        // Enable submit button
        document.getElementById('submitBtn').disabled = false;
    } else {
        // No conflicts - show detailed check results
        iconEl.innerHTML = `<svg class="w-6 h-6 text-green-500 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>`;
        titleEl.textContent = '‚úÖ No Conflicts Detected';
        titleEl.className = 'text-lg font-semibold text-green-800 mb-2';
        conflictBox.className = 'bg-green-50 border-l-4 border-green-500 rounded-lg shadow-sm p-6';
        
        let html = '<div class="space-y-3">';
        html += '<p class="text-sm text-green-700">This schedule has been verified and is ready to be created.</p>';
        
        // Show what was checked
        html += '<div class="mt-4 space-y-2">';
        html += '<p class="text-xs font-semibold text-green-800">‚úì Verified checks:</p>';
        html += '<div class="grid grid-cols-1 gap-2">';
        html += getCheckedItems();
        html += '</div>';
        html += '</div>';
        
        html += '<div class="mt-4 p-3 bg-green-100 rounded-lg">';
        html += '<p class="text-sm text-green-900 font-semibold">‚úì Ready to create</p>';
        html += '<p class="text-xs text-green-800 mt-1">All conflict checks passed successfully.</p>';
        html += '</div>';
        html += '</div>';
        
        detailsEl.innerHTML = html;

        // Enable submit button
        document.getElementById('submitBtn').disabled = false;
    }
}

function getCheckedItems() {
    const room = document.getElementById('room');
    const dayPattern = document.getElementById('day_pattern');
    const startTime = document.getElementById('start_time').value;
    const endTime = document.getElementById('end_time').value;
    const section = document.getElementById('section').value;
    const subject = document.getElementById('subject');
    
    const roomText = room.options[room.selectedIndex]?.text || 'N/A';
    const subjectText = subject.options[subject.selectedIndex]?.text || 'N/A';
    const dayText = dayPattern.options[dayPattern.selectedIndex]?.text || 'N/A';
    
    const start = new Date('2000-01-01 ' + startTime);
    const end = new Date('2000-01-01 ' + endTime);
    const startFormatted = start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    const endFormatted = end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit', hour12: true });
    
    let html = '';
    html += `<div class="flex items-start gap-2 bg-white bg-opacity-50 p-2 rounded">
        <span class="text-green-600 mt-0.5">üè¢</span>
        <div class="flex-1">
            <span class="font-semibold text-xs">Room:</span>
            <span class="text-xs ml-1">${roomText}</span>
        </div>
    </div>`;
    
    html += `<div class="flex items-start gap-2 bg-white bg-opacity-50 p-2 rounded">
        <span class="text-green-600 mt-0.5">üìÖ</span>
        <div class="flex-1">
            <span class="font-semibold text-xs">Schedule:</span>
            <span class="text-xs ml-1">${dayText} ${startFormatted} - ${endFormatted}</span>
        </div>
    </div>`;
    
    html += `<div class="flex items-start gap-2 bg-white bg-opacity-50 p-2 rounded">
        <span class="text-green-600 mt-0.5">üìö</span>
        <div class="flex-1">
            <span class="font-semibold text-xs">Subject & Section:</span>
            <span class="text-xs ml-1">${subjectText.substring(0, 40)} - Section ${section}</span>
        </div>
    </div>`;
    
    html += `<div class="flex items-start gap-2 bg-white bg-opacity-50 p-2 rounded">
        <span class="text-green-600 mt-0.5">‚úì</span>
        <div class="flex-1">
            <span class="text-xs">No room-time conflicts found</span>
        </div>
    </div>`;
    
    html += `<div class="flex items-start gap-2 bg-white bg-opacity-50 p-2 rounded">
        <span class="text-green-600 mt-0.5">‚úì</span>
        <div class="flex-1">
            <span class="text-xs">No duplicate subject-section</span>
        </div>
    </div>`;
    
    html += `<div class="flex items-start gap-2 bg-white bg-opacity-50 p-2 rounded">
        <span class="text-green-600 mt-0.5">‚úì</span>
        <div class="flex-1">
            <span class="text-xs">No section time conflicts</span>
        </div>
    </div>`;
    
    return html;
}

// Add event listeners for live checking
document.getElementById('subject').addEventListener('change', checkForConflicts);
document.getElementById('section').addEventListener('input', checkForConflicts);
document.getElementById('semester').addEventListener('change', checkForConflicts);
document.getElementById('academic_year').addEventListener('change', checkForConflicts);
document.getElementById('room').addEventListener('change', checkForConflicts);
document.getElementById('day_pattern').addEventListener('change', checkForConflicts);
document.getElementById('start_time').addEventListener('change', checkForConflicts);
document.getElementById('end_time').addEventListener('change', checkForConflicts);

// Filter subjects by semester dropdown
function filterSubjectsBySemester() {
    const filterSelect = document.getElementById('semester-view-filter');
    const subjectSelect = document.getElementById('subject');
    const filterStatusText = document.getElementById('filter-status-text');
    const activeSemester = '{{ activeSemester }}';
    
    const filterValue = filterSelect.value;
    const options = subjectSelect.querySelectorAll('option');
    
    let visibleCount = 0;
    
    options.forEach(option => {
        if (option.value === '') {
            // Keep the "Choose a subject..." option always visible
            option.style.display = '';
            return;
        }
        
        const subjectSemester = option.getAttribute('data-subject-semester');
        
        if (filterValue === 'active') {
            // Show only active semester subjects
            if (subjectSemester === activeSemester) {
                option.style.display = '';
                visibleCount++;
            } else {
                option.style.display = 'none';
            }
        } else {
            // Show all subjects
            option.style.display = '';
            visibleCount++;
        }
    });
    
    // Update status text
    if (filterValue === 'active') {
        filterStatusText.innerHTML = `Showing only <strong>${activeSemester}</strong> semester subjects. (${visibleCount} subjects)`;
    } else {
        filterStatusText.innerHTML = `Showing <strong>all</strong> semester subjects for reference. (${visibleCount} subjects)`;
    }
    
    // Reset the subject selection if current selection is now hidden
    const currentSelection = subjectSelect.value;
    if (currentSelection) {
        const currentOption = subjectSelect.querySelector(`option[value="${currentSelection}"]`);
        if (currentOption && currentOption.style.display === 'none') {
            subjectSelect.value = '';
            updateSubjectInfo();
        }
    }
}

// Auto-update existing sections display if semester/year are pre-selected
window.addEventListener('DOMContentLoaded', function() {
    const semester = document.getElementById('semester').value;
    const academicYear = document.getElementById('academic_year').value;
    
    // Apply the default filter on page load
    filterSubjectsBySemester();
    
    // If both are pre-selected (active semester), update the display
    if (semester && academicYear) {
        console.log('Active semester pre-selected:', semester, academicYear);
        updateExistingSectionsDisplay();
    }
});
</script>

{% endblock %}
